{% extends "base.html" %}
{% from 'macros/alerts.html' import success_message, error_message %}

{% block conteudo %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-3">
            <div class="list-group mb-3">
                <a href="/perfil/dados" class="list-group-item list-group-item-action active">
                    <i class="bi-person"></i> Meus Dados
                </a>
                <a href="/perfil/alterar-senha" class="list-group-item list-group-item-action">
                    <i class="bi-key"></i> Alterar Senha
                </a>
                <a href="/perfil/enderecos" class="list-group-item list-group-item-action">
                    <i class="bi-geo-alt"></i> Endereços
                </a>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-center">
                        <img id="foto-atual" src="{{ usuario.foto or '/static/img/user-default.png' }}"
                            class="rounded-circle mb-3 profile-img-150 profile-img-border-gray"
                            alt="Foto do perfil">
                    </div>
                    <div id="preview-foto-container" class="d-none">
                        <div class="d-flex justify-content-center">
                            <img id="preview-foto" src="" class="rounded-circle mb-2 profile-img-150 profile-img-border-success"
                                alt="Preview da nova foto">
                        </div>
                        <div class="small text-success mb-2">
                            <i class="bi-check-circle"></i> Nova foto selecionada
                        </div>
                    </div>
                    <h5>{{ usuario.nome }}</h5>
                    <p class="text-muted">{{ usuario.perfil|title }}</p>
                    <hr>
                    <form action="/perfil/alterar-foto" method="post" enctype="multipart/form-data" id="form-foto">
                        <div class="mb-2">
                            <label for="foto" class="form-label small">Selecionar Nova Foto</label>
                            <input type="file" class="form-control form-control-sm" id="foto" name="foto"
                                accept="image/*">
                            <div class="form-text small">JPG, JPEG ou PNG</div>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-primary" id="btn-alterar" disabled>
                            <i class="bi-camera"></i> Alterar Foto
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary d-none" id="btn-cancelar"
                            onclick="cancelarSelecao()">
                            <i class="bi-x"></i> Cancelar
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Meus Dados</h4>
                </div>
    
                <div class="card-body">
                    {% if request.query_params.get('sucesso') %}
                        {{ success_message('Dados atualizados com sucesso!', dismissible=True) }}
                    {% endif %}

                    {% if request.query_params.get('foto_sucesso') %}
                        {{ success_message('Foto atualizada com sucesso!', dismissible=True) }}
                    {% endif %}

                    {% if request.query_params.get('erro') == 'tipo_invalido' %}
                        {{ error_message('Tipo de arquivo inválido! Use apenas JPG, JPEG ou PNG.', dismissible=True) }}
                    {% endif %}

                    {% if request.query_params.get('erro') == 'upload_falhou' %}
                        {{ error_message('Erro ao fazer upload da foto. Tente novamente.', dismissible=True) }}
                    {% endif %}

                    {{ error_message(erro) }}

                    <form method="post" action="/perfil/dados">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="nome" class="form-label">Nome Completo</label>
                                    <input type="text" class="form-control" id="nome" name="nome"
                                        value="{{ usuario.nome }}" required>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="email" name="email"
                                        value="{{ usuario.email }}" required>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cpf" class="form-label">CPF</label>
                                    <input type="text" class="form-control" id="cpf" name="cpf"
                                        value="{{ cliente_dados.cpf }}" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                                        title="Formato: 000.000.000-00">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telefone" class="form-label">Telefone</label>
                                    <input type="tel" class="form-control" id="telefone" name="telefone"
                                        value="{{ cliente_dados.telefone }}" pattern="\(\d{2}\) \d{4,5}-\d{4}"
                                        title="Formato: (00) 0000-0000 ou (00) 00000-0000">
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="d-flex justify-content-center">
                                        <img id="foto-atual" src="{{ usuario.foto or '/static/img/user-default.png' }}"
                                            class="rounded-circle mb-3"
                                            class="profile-img-150 profile-img-border-gray"
                                            alt="Foto do perfil">
                                    </div>

                                    <!-- Preview da nova foto -->
                                    <div id="preview-foto-container" class="d-none">
                                        <div class="d-flex justify-content-center">
                                            <img id="preview-foto" src=""
                                                class="rounded-circle mb-2"
                                                class="profile-img-150 profile-img-border-success"
                                                alt="Preview da nova foto">
                                        </div>
                                        <div class="small text-success mb-2">
                                            <i class="bi-check-circle"></i> Nova foto selecionada
                                        </div>
                                    </div>

                                    <h5>{{ usuario.nome }}</h5>
                                    <p class="text-muted">{{ usuario.perfil|title }}</p>

                                    <hr>

                                    <form action="/perfil/alterar-foto" method="post" enctype="multipart/form-data" id="form-foto">
                                        <div class="mb-2">
                                            <label for="foto" class="form-label small">Selecionar Nova Foto</label>
                                            <input type="file" class="form-control form-control-sm"
                                                id="foto" name="foto" accept="image/*">
                                            <div class="form-text small">JPG, JPEG ou PNG</div>
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-outline-primary" id="btn-alterar" disabled>
                                            <i class="bi-camera"></i> Alterar Foto
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary d-none" id="btn-cancelar" onclick="cancelarSelecao()">
                                            <i class="bi-x"></i> Cancelar
                                        </button>
                                    </form>
                                </div>
                            </div> 

                            {% if usuario.perfil == 'contratante' and cliente_dados %}
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="parentesco_paciente" class="form-label">Parentesco com o
                                        Paciente</label>
                                    <input type="text" class="form-control" id="parentesco_paciente"
                                        name="parentesco_paciente" value="{{ cliente_dados.parentesco_paciente }}"
                                        required>
                                </div>
                            </div>
                            {% endif %}

                            {% if usuario.perfil == 'cuidador' and cuidador_dados %}
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Especialidade</label>
                                    <input type="text" class="form-control" value="{{ cuidador_dados.especialidade }}"
                                        readonly>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Experiência</label>
                                    <input type="text" class="form-control" value="{{ cuidador_dados.experiencia }}"
                                        readonly>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Hora</label>
                                    <input type="text" class="form-control" value="{{ cuidador_dados.valorHora }}"
                                        readonly>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Escolaridade</label>
                                    <input type="text" class="form-control" value="{{ cuidador_dados.escolaridade }}"
                                        readonly>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="apresentacao" class="form-label">Apresentação</label>
                                    <textarea class="form-control" id="apresentacao" name="apresentacao" rows="4"
                                        placeholder="Descreva sua experiência e apresentação pessoal."
                                        required>{{ cuidador_dados.apresentacao }}</textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Função para exibir o preview da foto de perfil
document.addEventListener('DOMContentLoaded', function() {
    const fotoInput = document.getElementById('foto');
    const fotoAtual = document.getElementById('foto-atual');
    const previewContainer = document.getElementById('preview-foto-container');
    const previewFoto = document.getElementById('preview-foto');
    const btnAlterar = document.getElementById('btn-alterar');
    const btnCancelar = document.getElementById('btn-cancelar');

    fotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];

        if (file) {
            // Verificar se é uma imagem
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    // Esconder foto atual e mostrar preview
                    fotoAtual.style.display = 'none';
                    previewFoto.src = e.target.result;
                    previewContainer.style.display = 'block';

                    // Habilitar botão e mostrar opções
                    btnAlterar.disabled = false;
                    btnAlterar.textContent = ' Confirmar Alteração';
                    btnAlterar.innerHTML = '<i class="bi-check"></i> Confirmar Alteração';
                    btnCancelar.style.display = 'inline-block';
                };

                reader.readAsDataURL(file);
            } else {
                alert('Por favor, selecione apenas arquivos de imagem (JPG, JPEG ou PNG).');
                cancelarSelecao();
            }
        } else {
            cancelarSelecao();
        }
    });

    function cancelarSelecao() {
        const fotoInput = document.getElementById('foto');
        const fotoAtual = document.getElementById('foto-atual');
        const previewContainer = document.getElementById('preview-foto-container');
        const btnAlterar = document.getElementById('btn-alterar');
        const btnCancelar = document.getElementById('btn-cancelar');

        // Limpar seleção
        fotoInput.value = '';

        // Mostrar foto atual e esconder preview
        fotoAtual.style.display = 'block';
        previewContainer.style.display = 'none';

        // Resetar botões
        btnAlterar.disabled = true;
        btnAlterar.innerHTML = '<i class="bi-camera"></i> Alterar Foto';
        btnCancelar.style.display = 'none';
    }
});

</script>

{% endblock %}